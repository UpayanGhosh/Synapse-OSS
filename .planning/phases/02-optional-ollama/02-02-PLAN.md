---
phase: 02-optional-ollama
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - synapse_onboard.bat
  - synapse_onboard.sh
autonomous: true
requirements:
  - OLL-04

must_haves:
  truths:
    - "synapse_onboard.bat completes without error on a machine with no Ollama installed"
    - "synapse_onboard.sh completes without error on a machine with no Ollama installed"
    - "Both scripts print a clear optional-feature warning when Ollama is absent, not an error that blocks setup"
    - "The ollama pull nomic-embed-text command runs only when Ollama is detected"
  artifacts:
    - path: "synapse_onboard.bat"
      provides: "Ollama check demoted to optional-warning; pull command gated on Ollama presence"
      contains: "ollama is NOT installed -- local embedding"
    - path: "synapse_onboard.sh"
      provides: "Ollama removed from all_good check; OLLAMA_FOUND flag added; serve/pull block gated"
      contains: "OLLAMA_FOUND"
  key_links:
    - from: "synapse_onboard.bat Ollama check block"
      to: "MISSING flag"
      via: "Ollama check must NOT set MISSING=1"
      pattern: "ollama.*MISSING"
    - from: "synapse_onboard.bat pull command (line ~234)"
      to: "OLLAMA_FOUND guard"
      via: "start /B ollama pull must be inside if defined OLLAMA_FOUND block"
      pattern: "if defined OLLAMA_FOUND"
    - from: "synapse_onboard.sh check_tool ollama"
      to: "all_good flag"
      via: "ollama must NOT be in check_tool ... || all_good=false list"
      pattern: "all_good"
---

<objective>
Remove Ollama from the hard-required tool checks in both onboarding scripts so users without Ollama can complete onboarding without hitting a blocking error. Replace the hard-fail with an optional-feature warning and gate the ollama pull command behind an Ollama-found check.

Purpose: OLL-04 — both scripts currently set MISSING=1 (bat) or all_good=false (sh) when Ollama is absent, causing onboarding to exit with a "tools are missing" error. Ollama is optional; users without it should see a warning and continue.

Output: synapse_onboard.bat and synapse_onboard.sh with Ollama demoted to optional check with clear warning messages, pull commands gated on Ollama availability.
</objective>

<execution_context>
@C:/Users/upayan.ghosh/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/upayan.ghosh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-optional-ollama/02-RESEARCH.md

<interfaces>
<!-- Current state of the relevant sections to change. -->

From synapse_onboard.bat (lines 59-66 — current Ollama check block):
```batch
REM Check Ollama
where ollama >nul 2>&1
if %ERRORLEVEL% NEQ 0 (
    echo    [X] ollama is NOT installed
    set "MISSING=1"
) else (
    echo    [OK] ollama is installed
)
```

From synapse_onboard.bat (lines 231-235 — Ollama pull at end of Step 7):
```batch
REM Pull required Ollama embedding model in background (first-time setup)
echo.
echo Pulling Ollama embedding model ^(nomic-embed-text^) in background...
start /B ollama pull nomic-embed-text >nul 2>&1
echo [OK] Pull started. ^(First run may take a few minutes in the background.^)
```

From synapse_onboard.sh (line 47 — Ollama in required check list):
```bash
check_tool ollama    || all_good=false
```

From synapse_onboard.sh (lines 271-285 — Ollama serve + pull block):
```bash
echo "[2/4] Starting Ollama..."
export OLLAMA_KEEP_ALIVE=0
export OLLAMA_MAX_LOADED_MODELS=1
export OLLAMA_NUM_PARALLEL=1
if ! pgrep -f "ollama serve" > /dev/null; then
    nohup ollama serve > ~/.openclaw/logs/ollama.log 2>&1 &
    echo "   ✓ Ollama started"
    sleep 3
    echo "   Pulling required embedding model (nomic-embed-text)..."
    ollama pull nomic-embed-text >> ~/.openclaw/logs/ollama.log 2>&1 &
    echo "   ✓ nomic-embed-text pull started in background"
else
    echo "   ✓ Ollama already running"
fi
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Demote Ollama to optional in synapse_onboard.bat</name>
  <files>synapse_onboard.bat</files>
  <action>
Make two targeted changes to synapse_onboard.bat.

**Change 1 — Replace the Ollama check block (lines ~59-66):**
Replace:
```batch
REM Check Ollama
where ollama >nul 2>&1
if %ERRORLEVEL% NEQ 0 (
    echo    [X] ollama is NOT installed
    set "MISSING=1"
) else (
    echo    [OK] ollama is installed
)
```
With:
```batch
REM Check Ollama (OPTIONAL -- needed for local embedding and The Vault)
where ollama >nul 2>&1
if %ERRORLEVEL% NEQ 0 (
    echo    [--] ollama is NOT installed -- local embedding and The Vault will be disabled
    echo         Install from: https://ollama.com (optional, app will run without it)
) else (
    echo    [OK] ollama is installed
    set "OLLAMA_FOUND=1"
)
```
Key: do NOT set `MISSING=1` in the Ollama block. The `set "OLLAMA_FOUND=1"` line is new — it enables the guard in Change 2.

**Change 2 — Gate the ollama pull command (lines ~231-235):**
Replace:
```batch
REM Pull required Ollama embedding model in background (first-time setup)
echo.
echo Pulling Ollama embedding model ^(nomic-embed-text^) in background...
start /B ollama pull nomic-embed-text >nul 2>&1
echo [OK] Pull started. ^(First run may take a few minutes in the background.^)
```
With:
```batch
REM Pull Ollama embedding model only if Ollama is installed
if defined OLLAMA_FOUND (
    echo.
    echo Pulling Ollama embedding model ^(nomic-embed-text^) in background...
    start /B ollama pull nomic-embed-text >nul 2>&1
    echo [OK] Pull started. ^(First run may take a few minutes in the background.^)
)
```

Do not change any other part of the file.
  </action>
  <verify>
    <automated>grep -n "MISSING\|OLLAMA_FOUND\|ollama is NOT\|ollama.*optional" /c/Users/upayan.ghosh/personal/Jarvis-OSS/synapse_onboard.bat</automated>
  </verify>
  <done>
    - Ollama check block: no `set "MISSING=1"` line, has `set "OLLAMA_FOUND=1"` on success path, prints "[--]" + optional message on failure path
    - ollama pull command: wrapped in `if defined OLLAMA_FOUND (` block
    - `grep "MISSING=1" synapse_onboard.bat | grep -i ollama` returns zero results
  </done>
</task>

<task type="auto">
  <name>Task 2: Demote Ollama to optional in synapse_onboard.sh</name>
  <files>synapse_onboard.sh</files>
  <action>
Make two targeted changes to synapse_onboard.sh.

**Change 1 — Remove Ollama from the check_tool required list (line ~47):**
The current line is:
```bash
check_tool ollama    || all_good=false
```
Replace this single line with a standalone optional check that does NOT set `all_good=false`:
```bash
# Ollama check -- optional (needed for local embedding and The Vault)
if command -v ollama &> /dev/null; then
    echo "   [OK] ollama is installed"
    OLLAMA_FOUND=true
else
    echo "   [--] ollama NOT installed -- local embedding and The Vault disabled"
    echo "        Install from: https://ollama.com (optional)"
    OLLAMA_FOUND=false
fi
```
The `OLLAMA_FOUND` variable is declared here and used in Change 2.

**Change 2 — Gate the Ollama serve + pull block (lines ~270-285):**
The current Step 3 "[2/4] Starting Ollama..." block runs unconditionally. Wrap the entire block in an `if [ "$OLLAMA_FOUND" = true ]; then ... fi` guard:
```bash
if [ "$OLLAMA_FOUND" = true ]; then
    echo ""
    echo "[2/4] Starting Ollama..."
    export OLLAMA_KEEP_ALIVE=0
    export OLLAMA_MAX_LOADED_MODELS=1
    export OLLAMA_NUM_PARALLEL=1
    if ! pgrep -f "ollama serve" > /dev/null; then
        nohup ollama serve > ~/.openclaw/logs/ollama.log 2>&1 &
        echo "   [OK] Ollama started"
        sleep 3
        echo "   Pulling required embedding model (nomic-embed-text)..."
        ollama pull nomic-embed-text >> ~/.openclaw/logs/ollama.log 2>&1 &
        echo "   [OK] nomic-embed-text pull started in background"
    else
        echo "   [OK] Ollama already running"
    fi
else
    echo ""
    echo "[2/4] Ollama not installed -- skipping (local embedding disabled)"
fi
```

Note: The .sh script currently uses emoji in its output (e.g., "✓" and "[2/4]"). The Phase 1 Unicode fix replaced emoji at source in workspace Python files. The onboarding scripts are shell scripts, not Python — they run in terminal emulators that handle Unicode fine on Mac/Linux. Do NOT replace the emoji in the .sh file as that is out of scope. For the Ollama-specific output lines you are adding, use `[OK]`, `[--]` ASCII markers (matching the style already used in existing lines you reference in the RESEARCH.md patterns).

Do not change any other part of the file.
  </action>
  <verify>
    <automated>grep -n "OLLAMA_FOUND\|all_good.*ollama\|ollama.*all_good\|check_tool ollama" /c/Users/upayan.ghosh/personal/Jarvis-OSS/synapse_onboard.sh</automated>
  </verify>
  <done>
    - `check_tool ollama || all_good=false` line removed entirely
    - OLLAMA_FOUND variable set in standalone check block
    - Ollama serve + pull block wrapped in `if [ "$OLLAMA_FOUND" = true ]`
    - `grep "all_good.*ollama\|ollama.*all_good" synapse_onboard.sh` returns zero results
    - `grep "OLLAMA_FOUND" synapse_onboard.sh` returns at least 3 matches (declaration + two uses)
  </done>
</task>

</tasks>

<verification>
Run these checks after both tasks complete:

1. Confirm Ollama no longer blocks the bat script:
   ```bash
   grep -n "MISSING=1" /c/Users/upayan.ghosh/personal/Jarvis-OSS/synapse_onboard.bat
   ```
   Must return only git, python, docker, and openclaw lines — NOT an ollama line.

2. Confirm Ollama pull is gated in bat:
   ```bash
   grep -n -A2 "ollama pull" /c/Users/upayan.ghosh/personal/Jarvis-OSS/synapse_onboard.bat
   ```
   Must show the pull command inside an `if defined OLLAMA_FOUND` block.

3. Confirm Ollama removed from sh required checks:
   ```bash
   grep -n "check_tool ollama" /c/Users/upayan.ghosh/personal/Jarvis-OSS/synapse_onboard.sh
   ```
   Must return zero results.

4. Confirm OLLAMA_FOUND used in sh:
   ```bash
   grep -n "OLLAMA_FOUND" /c/Users/upayan.ghosh/personal/Jarvis-OSS/synapse_onboard.sh
   ```
   Must return at least 3 results (set + two references).

5. Bash syntax check on .sh:
   ```bash
   bash -n /c/Users/upayan.ghosh/personal/Jarvis-OSS/synapse_onboard.sh && echo "Syntax OK"
   ```
</verification>

<success_criteria>
- synapse_onboard.bat: Running on a machine without Ollama does NOT hit the "Some tools are missing" error block — Ollama absence prints "[--] ollama is NOT installed -- local embedding and The Vault will be disabled" and continues
- synapse_onboard.bat: `ollama pull` command runs only when OLLAMA_FOUND is set
- synapse_onboard.sh: `check_tool ollama || all_good=false` is gone; replaced by standalone OLLAMA_FOUND check
- synapse_onboard.sh: Ollama serve/pull block is gated inside `if [ "$OLLAMA_FOUND" = true ]`
- `bash -n synapse_onboard.sh` exits 0 (no syntax errors)
</success_criteria>

<output>
After completion, create `.planning/phases/02-optional-ollama/02-02-SUMMARY.md` using the summary template.
</output>
