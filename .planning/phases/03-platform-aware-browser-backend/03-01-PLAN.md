---
phase: 03-platform-aware-browser-backend
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - requirements.txt
  - synapse_onboard.bat
autonomous: true
requirements:
  - BRW-01
  - BRW-02
  - BRW-03

must_haves:
  truths:
    - "pip install -r requirements.txt on Windows 11 completes without error (crawl4ai skipped, playwright installed)"
    - "pip install -r requirements.txt on Mac/Linux continues to install crawl4ai and skips playwright"
    - "synapse_onboard.bat runs python -m playwright install chromium unconditionally (outside the venv-creation if block)"
    - "Playwright install step in bat prints [OK] on success or [--] on failure with manual fallback instruction"
  artifacts:
    - path: "requirements.txt"
      provides: "PEP 508 platform-gated browser dependencies"
      contains: "crawl4ai>=0.2.0 ; sys_platform != 'win32'"
    - path: "synapse_onboard.bat"
      provides: "Playwright browser binary installation step"
      contains: "python -m playwright install chromium"
  key_links:
    - from: "requirements.txt"
      to: "pip install on Windows"
      via: "sys_platform != 'win32' marker on crawl4ai line"
      pattern: "sys_platform != 'win32'"
    - from: "synapse_onboard.bat"
      to: "Playwright Chromium binary"
      via: "python -m playwright install chromium after pip install block"
      pattern: "playwright install chromium"
---

<objective>
Add PEP 508 platform markers to requirements.txt so crawl4ai is not installed on Windows and playwright is installed instead. Add the playwright binary installation step to synapse_onboard.bat so Chromium is available when the /browse tool runs.

Purpose: This makes `pip install -r requirements.txt` succeed on Windows 11 (crawl4ai has build failures on Windows confirmed by multiple GitHub issues). Without this, new Windows users hit errors at the very first install step.

Output: Updated requirements.txt with platform markers; updated synapse_onboard.bat with unconditional playwright binary install.
</objective>

<execution_context>
@C:/Users/upayan.ghosh/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/upayan.ghosh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@requirements.txt
@synapse_onboard.bat
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add PEP 508 platform markers to requirements.txt</name>
  <files>requirements.txt</files>
  <action>
In the `# --- Web Browsing & Scraping ---` section, replace the current bare crawl4ai line with a platform-gated version, and add a playwright line below it.

Current line (line 37):
```
crawl4ai>=0.2.0                  # Headless browser automation (ToolRegistry /browse)
```

Replace with these two lines:
```
crawl4ai>=0.2.0 ; sys_platform != 'win32'   # Headless browser automation -- Mac/Linux only (Windows: fails to install)
playwright>=1.20.0 ; sys_platform == 'win32' # Windows browser automation -- replaces crawl4ai on Windows
```

The section comment above (`# --- Web Browsing & Scraping ---`) should be updated to read:
```
# --- Web Browsing & Scraping ---
# crawl4ai on Mac/Linux; playwright on Windows (crawl4ai has build failures on Windows)
```

IMPORTANT: Do NOT use outer quotes in the marker strings — `; sys_platform != 'win32'` is correct, not `; sys_platform != "win32"`. Single quotes are part of the PEP 508 micro-language syntax. pip has supported markers since pip 6.0.

`sys_platform` values: `win32` = all Windows (32 and 64-bit), `darwin` = macOS, `linux` = Linux.
  </action>
  <verify>
    <automated>cd C:/Users/upayan.ghosh/personal/Jarvis-OSS && grep "crawl4ai" requirements.txt && grep "playwright" requirements.txt</automated>
  </verify>
  <done>requirements.txt contains `crawl4ai>=0.2.0 ; sys_platform != 'win32'` and `playwright>=1.20.0 ; sys_platform == 'win32'` — both lines present, no bare crawl4ai line remains.</done>
</task>

<task type="auto">
  <name>Task 2: Add playwright binary install to synapse_onboard.bat (unconditionally)</name>
  <files>synapse_onboard.bat</files>
  <action>
The current Step 2 block (lines 129-142) looks like:

```batch
REM Step 2: Set up Python environment
echo.
echo Step 2: Setting up Python...
echo.

if not exist "%PROJECT_ROOT%\.venv\Scripts\python.exe" (
    echo Creating virtual environment...
    python -m venv "%PROJECT_ROOT%\.venv"
    echo Installing dependencies...
    call "%PROJECT_ROOT%\.venv\Scripts\pip.exe" install -r "%PROJECT_ROOT%\requirements.txt"
    echo [OK] Virtual environment ready.
) else (
    echo [OK] Virtual environment already exists.
)

REM Step 3: Set up Docker
```

The playwright install step MUST be placed AFTER the closing `)` of the if/else block and BEFORE `REM Step 3: Set up Docker`. This ensures it runs unconditionally — even when the venv already exists (users who ran onboard before Phase 3 must still get playwright binaries).

Insert the following block between the `else` block close `)` and `REM Step 3: Set up Docker`:

```batch
REM Install Playwright browser binaries (Windows only -- replaces crawl4ai)
echo Installing Playwright browser binaries (Chromium)...
call "%PROJECT_ROOT%\.venv\Scripts\python.exe" -m playwright install chromium
if %ERRORLEVEL% NEQ 0 (
    echo [--] Playwright browser install failed -- /browse tool will not work
    echo      Try manually: python -m playwright install chromium
) else (
    echo [OK] Playwright Chromium ready.
)
```

This is warn-only (uses `[--]` not hard-fail) consistent with how Ollama is treated in Phase 2. The browse tool is non-critical; the app still runs without it.

`python -m playwright install chromium` is idempotent — running it when Chromium is already installed is safe and fast.
  </action>
  <verify>
    <automated>cd C:/Users/upayan.ghosh/personal/Jarvis-OSS && grep -n "playwright install chromium" synapse_onboard.bat</automated>
  </verify>
  <done>synapse_onboard.bat contains `playwright install chromium` on a line that is outside (after) the `if not exist ".venv\Scripts\python.exe"` block, confirmed by line number being after line 142 and before the Step 3 Docker section.</done>
</task>

</tasks>

<verification>
1. `grep "crawl4ai" requirements.txt` shows line with `sys_platform != 'win32'` marker
2. `grep "playwright" requirements.txt` shows line with `sys_platform == 'win32'` marker
3. No bare `crawl4ai>=` line without a marker exists: `grep -v "sys_platform" requirements.txt | grep "crawl4ai"` returns empty
4. `grep -n "playwright install chromium" synapse_onboard.bat` returns a line number greater than 142 (outside venv if block)
</verification>

<success_criteria>
- requirements.txt: crawl4ai has `; sys_platform != 'win32'` marker, playwright has `; sys_platform == 'win32'` marker
- On Windows: pip install will skip crawl4ai and install playwright
- On Mac/Linux: pip install will skip playwright and install crawl4ai
- synapse_onboard.bat: playwright binary install runs unconditionally after the venv setup block
- playwright install failure prints `[--]` warning with manual fallback instruction, does not abort setup
</success_criteria>

<output>
After completion, create `.planning/phases/03-platform-aware-browser-backend/03-01-SUMMARY.md` with:
- What was changed in requirements.txt (exact lines before/after)
- Where in synapse_onboard.bat the playwright install was inserted (line numbers)
- Verification command outputs confirming markers are present
</output>
