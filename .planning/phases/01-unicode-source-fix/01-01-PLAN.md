---
phase: 01-unicode-source-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - workspace/change_tracker.py
  - workspace/change_viewer.py
  - workspace/finish_facts.py
  - workspace/main.py
  - workspace/monitor.py
  - workspace/purge_trash.py
  - workspace/sci_fi_dashboard/api_gateway.py
  - workspace/sci_fi_dashboard/build_persona.py
  - workspace/sci_fi_dashboard/chat_parser.py
  - workspace/sci_fi_dashboard/conflict_resolver.py
  - workspace/sci_fi_dashboard/db.py
  - workspace/sci_fi_dashboard/dual_cognition.py
  - workspace/sci_fi_dashboard/emotional_trajectory.py
  - workspace/sci_fi_dashboard/gateway/worker.py
  - workspace/sci_fi_dashboard/gentle_worker.py
  - workspace/sci_fi_dashboard/ingest.py
  - workspace/sci_fi_dashboard/memory_engine.py
  - workspace/sci_fi_dashboard/migrate_graph.py
  - workspace/sci_fi_dashboard/narrative.py
  - workspace/sci_fi_dashboard/persona.py
  - workspace/sci_fi_dashboard/retriever.py
  - workspace/sci_fi_dashboard/sbs/injection/compiler.py
  - workspace/sci_fi_dashboard/sbs/processing/batch.py
  - workspace/sci_fi_dashboard/sbs/processing/realtime.py
  - workspace/sci_fi_dashboard/sbs/processing/selectors/exemplar.py
  - workspace/sci_fi_dashboard/sbs/profile/manager.py
  - workspace/sci_fi_dashboard/sbs/sentinel/gateway.py
  - workspace/sci_fi_dashboard/sbs/sentinel/manifest.py
  - workspace/sci_fi_dashboard/sbs/vacuum.py
  - workspace/sci_fi_dashboard/sbs_bootstrap.py
  - workspace/sci_fi_dashboard/smart_entity.py
  - workspace/sci_fi_dashboard/sqlite_graph.py
  - workspace/sci_fi_dashboard/toxic_scorer_lazy.py
  - workspace/sci_fi_dashboard/ui_components.py
  - workspace/sci_fi_dashboard/verify_dual_cognition.py
  - workspace/sci_fi_dashboard/verify_soul.py
  - workspace/scripts/db_cleanup.py
  - workspace/scripts/db_organize.py
  - workspace/scripts/dsa_logger.py
  - workspace/scripts/fact_extractor.py
  - workspace/scripts/genesis.py
  - workspace/scripts/latency_watcher.py
  - workspace/scripts/memory_test.py
  - workspace/scripts/migrate_temporal.py
  - workspace/scripts/nightly_ingest.py
  - workspace/scripts/prune_sessions.py
  - workspace/scripts/ram_watchdog.py
  - workspace/scripts/sanitizer.py
  - workspace/scripts/update_memory_schema.py
  - workspace/scripts/v2_migration/migrate_vectors.py
  - workspace/skills/google_native.py
  - workspace/skills/memory/ingest_memories.py
  - workspace/tests/test_e2e.py
  - workspace/utils/env_loader.py
  - synapse_start.sh
  - synapse_start.bat
autonomous: true
requirements:
  - ENC-01
  - ENC-02

must_haves:
  truths:
    - "Running `py -c \"import workspace.sci_fi_dashboard.api_gateway\"` from the project root produces no UnicodeEncodeError"
    - "Running `grep -rn \"[^\\x00-\\x7F]\" workspace/ --include=\"*.py\"` returns zero results"
    - "All 54 affected workspace Python files have been rewritten with ASCII-only content"
    - "synapse_start.sh exports PYTHONUTF8=1 before the uvicorn invocation"
    - "synapse_start.bat sets PYTHONUTF8=1 before the uvicorn invocation"
  artifacts:
    - path: "workspace/sci_fi_dashboard/smart_entity.py"
      provides: "Primary crash site â€” fixed"
      contains: "[OK]"
    - path: "workspace/sci_fi_dashboard/api_gateway.py"
      provides: "Boot entry point â€” fixed"
    - path: "workspace/monitor.py"
      provides: "Highest-density file (102 non-ASCII lines) â€” fixed"
    - path: "synapse_start.sh"
      provides: "Defense-in-depth env var"
      contains: "PYTHONUTF8=1"
    - path: "synapse_start.bat"
      provides: "Defense-in-depth env var (Windows)"
      contains: "PYTHONUTF8=1"
  key_links:
    - from: "replacement script (run at execution time)"
      to: "all 54 workspace/*.py files"
      via: "os.walk + str.replace for each entry in REPLACEMENTS map"
      pattern: "open.*encoding.*utf-8.*replace"
    - from: "synapse_start.bat"
      to: "uvicorn process"
      via: "set PYTHONUTF8=1 before start /B cmd"
      pattern: "PYTHONUTF8=1"
    - from: "synapse_start.sh"
      to: "uvicorn process"
      via: "export PYTHONUTF8=1 at script top"
      pattern: "export PYTHONUTF8=1"
---

<objective>
Replace all non-ASCII characters (emoji, box-drawing characters, em-dashes) in all 54 affected workspace Python files with ASCII equivalents, then add PYTHONUTF8=1 as defense-in-depth in both start scripts.

Purpose: Eliminate the UnicodeEncodeError crash that prevents the app from booting on Windows (cp1252 encoding). The crash occurs at import time when module-level print/log statements containing emoji are executed before any encoding wrapper can be installed.

Output: 54 modified Python source files with zero non-ASCII characters; synapse_start.sh and synapse_start.bat both export PYTHONUTF8=1; grep verification returns zero hits.
</objective>

<execution_context>
@C:/Users/upayan.ghosh/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/upayan.ghosh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

<!-- Research provides the confirmed replacement map, exact file list, and all pitfalls. -->
@.planning/phases/01-unicode-source-fix/01-RESEARCH.md
</context>

<interfaces>
<!-- Key replacement map extracted from 01-RESEARCH.md for executor reference. -->
<!-- Apply ALL of these. Do not skip any entry. -->

```python
REPLACEMENTS = {
    # Status emoji
    "âœ…": "[OK]",
    "âŒ": "[ERROR]",
    "âš ï¸": "[WARN]",    # two chars: U+26A0 + U+FE0F â€” replace the full literal
    "ðŸš€": "[INFO]",
    # Action/state emoji
    "ðŸ“": "[LOG]",
    "ðŸ“‚": "[DIR]",
    "ðŸ”": "[SEARCH]",
    "â³": "[WAIT]",
    "â¸ï¸": "[PAUSED]",
    "â–¶ï¸": "[RESUME]",
    "â„¹ï¸": "[INFO]",
    "â±ï¸": "[TIME]",
    "ðŸ›‘": "[STOP]",
    "ðŸ‘‹": "[BYE]",
    "ðŸ‘ï¸": "[WATCH]",
    "ðŸ›¡ï¸": "[GUARD]",
    "ðŸŒ¿": "[BRANCH]",
    "ðŸš¨": "[ALERT]",
    "ðŸ“Š": "[STATS]",
    "ðŸ“œ": "[HISTORY]",
    "ðŸ§¬": "[PROC]",
    "ðŸ•µï¸": "[CHECK]",
    "ðŸ§¹": "[CLEAN]",
    "ðŸ”—": "[LINK]",
    "ðŸŒ": "[WEB]",
    "ðŸ“¡": "[FETCH]",
    "ðŸ’¬": "[REPLY]",
    "ðŸ§ ": "[MEM]",
    "ðŸ“¥": "[ADD]",
    "ðŸ“–": "[READ]",
    "âœ‰ï¸": "[MSG]",
    "ðŸ“…": "[CAL]",
    "ðŸ‘¥": "[CONTACTS]",
    "ðŸ’»": "[CMD]",
    "âš™ï¸": "[EVAL]",
    "ðŸ“§": "[EMAIL]",
    "ðŸ–¼ï¸": "[IMG]",
    "ðŸ¤–": "[BOT]",
    "ðŸ‘¤": "[USER]",
    "ðŸŒ": "[WEB]",
    "ðŸ“ˆ": "[CHART]",
    "ðŸ”’": "[LOCK]",
    "ðŸ”“": "[UNLOCK]",
    "ðŸŒ±": "[NEW]",
    # Box-drawing characters
    "\u2550": "=",    # â• double horizontal
    "\u2500": "-",    # â”€ single horizontal
    "\u2014": "--",   # â€” em-dash
    # Arrow (found in test_e2e.py docstring)
    "\u2192": "->",   # â†’ right arrow
    # Checkmark without variation selector (U+2713)
    "\u2713": "[OK]", # âœ“
    # Unicode bullet / middle dot variants sometimes present
    "\u2022": "*",    # â€¢ bullet
    "\u00b7": ".",    # Â· middle dot
}
```

**Replacement approach:**
```python
def fix_file(path: str) -> int:
    """Returns number of replacements made."""
    content = open(path, encoding="utf-8").read()
    original = content
    for emoji, replacement in REPLACEMENTS.items():
        content = content.replace(emoji, replacement)
    if content != original:
        open(path, "w", encoding="utf-8").write(content)
        return sum(original.count(e) for e in REPLACEMENTS)
    return 0
```

**Critical: apply replacements to ALL contexts** (comments, docstrings, string literals, print/log calls). ENC-02 grep runs on the whole file; any non-ASCII hit anywhere fails the verification.
</interfaces>

<tasks>

<task type="auto">
  <name>Task 1: Write and run workspace-wide ASCII replacement script</name>
  <files>
    workspace/change_tracker.py
    workspace/change_viewer.py
    workspace/finish_facts.py
    workspace/main.py
    workspace/monitor.py
    workspace/purge_trash.py
    workspace/sci_fi_dashboard/api_gateway.py
    workspace/sci_fi_dashboard/build_persona.py
    workspace/sci_fi_dashboard/chat_parser.py
    workspace/sci_fi_dashboard/conflict_resolver.py
    workspace/sci_fi_dashboard/db.py
    workspace/sci_fi_dashboard/dual_cognition.py
    workspace/sci_fi_dashboard/emotional_trajectory.py
    workspace/sci_fi_dashboard/gateway/worker.py
    workspace/sci_fi_dashboard/gentle_worker.py
    workspace/sci_fi_dashboard/ingest.py
    workspace/sci_fi_dashboard/memory_engine.py
    workspace/sci_fi_dashboard/migrate_graph.py
    workspace/sci_fi_dashboard/narrative.py
    workspace/sci_fi_dashboard/persona.py
    workspace/sci_fi_dashboard/retriever.py
    workspace/sci_fi_dashboard/sbs/injection/compiler.py
    workspace/sci_fi_dashboard/sbs/processing/batch.py
    workspace/sci_fi_dashboard/sbs/processing/realtime.py
    workspace/sci_fi_dashboard/sbs/processing/selectors/exemplar.py
    workspace/sci_fi_dashboard/sbs/profile/manager.py
    workspace/sci_fi_dashboard/sbs/sentinel/gateway.py
    workspace/sci_fi_dashboard/sbs/sentinel/manifest.py
    workspace/sci_fi_dashboard/sbs/vacuum.py
    workspace/sci_fi_dashboard/sbs_bootstrap.py
    workspace/sci_fi_dashboard/smart_entity.py
    workspace/sci_fi_dashboard/sqlite_graph.py
    workspace/sci_fi_dashboard/toxic_scorer_lazy.py
    workspace/sci_fi_dashboard/ui_components.py
    workspace/sci_fi_dashboard/verify_dual_cognition.py
    workspace/sci_fi_dashboard/verify_soul.py
    workspace/scripts/db_cleanup.py
    workspace/scripts/db_organize.py
    workspace/scripts/dsa_logger.py
    workspace/scripts/fact_extractor.py
    workspace/scripts/genesis.py
    workspace/scripts/latency_watcher.py
    workspace/scripts/memory_test.py
    workspace/scripts/migrate_temporal.py
    workspace/scripts/nightly_ingest.py
    workspace/scripts/prune_sessions.py
    workspace/scripts/ram_watchdog.py
    workspace/scripts/sanitizer.py
    workspace/scripts/update_memory_schema.py
    workspace/scripts/v2_migration/migrate_vectors.py
    workspace/skills/google_native.py
    workspace/skills/memory/ingest_memories.py
    workspace/tests/test_e2e.py
    workspace/utils/env_loader.py
  </files>
  <action>
    Write a Python script at the project root named `fix_unicode.py` that applies the full REPLACEMENTS map (from the interfaces block above) to every `.py` file found under `workspace/` via `os.walk`. The script must:

    1. Open each file with `encoding="utf-8"` (source files are valid UTF-8).
    2. Apply `str.replace` for every entry in REPLACEMENTS â€” do NOT filter by context (apply in comments, docstrings, string literals, and print/log calls alike). This is required for ENC-02.
    3. Write back with `encoding="utf-8"` only if the content changed (avoid unnecessary dirty writes).
    4. Print a summary line per modified file: `[FIXED] path/to/file.py (N replacements)`.
    5. Print a final total: `Done. N files modified, M total replacements.`

    Then run the script immediately:
    ```
    py -3 fix_unicode.py
    ```
    (On Mac/Linux: `python3 fix_unicode.py`)

    After the script runs, confirm the output shows at least 50 files modified and a non-zero total replacement count. If the script reports fewer than 50 files, the REPLACEMENTS map is incomplete â€” check for additional non-ASCII characters not in the map by re-running the grep and adding missing entries.

    Do NOT: use `re.sub` with context-aware patterns that try to match only inside print/log calls. Replacing in all contexts is simpler, correct, and required by ENC-02.

    Do NOT: delete fix_unicode.py after running. It stays as a utility script for re-runs.
  </action>
  <verify>
    <automated>py -3 -c "import sys; hits = [l for l in open('fix_unicode.py').readlines() if 'REPLACEMENTS' in l]; print('Script exists' if hits else 'MISSING')"</automated>
  </verify>
  <done>fix_unicode.py exists and has been executed. Console output shows 50+ files modified. Zero errors reported.</done>
</task>

<task type="auto">
  <name>Task 2: Verify zero non-ASCII remains and add PYTHONUTF8=1 defense-in-depth</name>
  <files>
    synapse_start.sh
    synapse_start.bat
    synapse_start.ps1
  </files>
  <action>
    **Step A â€” Grep verification (ENC-02):**

    Run the canonical verification command:
    ```bash
    grep -rn "[^\x00-\x7F]" workspace/ --include="*.py"
    ```
    Expected: zero output. If ANY hits remain, read the offending lines and add the missing characters to REPLACEMENTS in fix_unicode.py, then re-run `py -3 fix_unicode.py` and re-run grep until zero hits. Do not proceed to Step B until grep is clean.

    **Step B â€” Add PYTHONUTF8=1 to synapse_start.sh:**

    `synapse_start.sh` already exports `PYTHONUTF8=1` inside the `if ! pgrep` block (line ~28). Move or duplicate the export to the top-level of the script (before the first `echo` call) so it applies unconditionally to every Python subprocess, not just the uvicorn one. Specifically, add these two lines immediately after the `#!/bin/bash` shebang line (before any other code):

    ```bash
    export PYTHONUTF8=1
    export PYTHONIOENCODING=utf-8
    ```

    **Step C â€” Add PYTHONUTF8=1 to synapse_start.bat:**

    `synapse_start.bat` sets `PYTHONUTF8=1` only inside the uvicorn start block (line ~43). Add a top-level set immediately after the `chcp 65001 >nul` line (line 2) so it covers all Python invocations:

    ```batch
    set PYTHONUTF8=1
    set PYTHONIOENCODING=utf-8
    ```

    **Step D â€” Add PYTHONUTF8=1 to synapse_start.ps1 (if it exists and lacks it):**

    Check if `synapse_start.ps1` exists. If so, add at the top (after any `param` block):
    ```powershell
    $env:PYTHONUTF8 = "1"
    $env:PYTHONIOENCODING = "utf-8"
    ```

    **Step E â€” Lint check:**

    Run ruff on the modified workspace files to confirm no regressions were introduced by the replacements:
    ```bash
    ruff check workspace/ --quiet
    ```
    Expected: zero errors (or only pre-existing errors unrelated to this change). The replacements are pure string content changes and should not affect syntax.
  </action>
  <verify>
    <automated>grep -rn "[^\x00-\x7F]" workspace/ --include="*.py" | wc -l</automated>
  </verify>
  <done>
    - grep returns exactly 0 lines
    - synapse_start.sh has `export PYTHONUTF8=1` and `export PYTHONIOENCODING=utf-8` at the top (unconditionally, before any echo)
    - synapse_start.bat has `set PYTHONUTF8=1` and `set PYTHONIOENCODING=utf-8` at the top (after chcp line)
    - ruff reports no new errors introduced by this change
  </done>
</task>

</tasks>

<verification>
Run these commands in order from the project root after both tasks complete:

1. Grep must return zero:
   ```bash
   grep -rn "[^\x00-\x7F]" workspace/ --include="*.py"
   ```

2. Confirm start scripts have defense-in-depth:
   ```bash
   grep -n "PYTHONUTF8" synapse_start.sh synapse_start.bat
   ```
   Expected: at least one hit in each file, both near the top.

3. Lint check:
   ```bash
   ruff check workspace/ --quiet
   ```

4. Smoke test (import the entry point â€” simulates Windows cp1252 boot without needing a Windows machine):
   ```bash
   py -3 -c "import sys; sys.stdout.reconfigure(encoding='cp1252'); import workspace.sci_fi_dashboard.api_gateway" 2>&1 | head -5
   ```
   Expected: no UnicodeEncodeError. (Will likely produce other import errors on this dev machine due to missing services â€” those are acceptable. Only UnicodeEncodeError is a failure.)
</verification>

<success_criteria>
- `grep -rn "[^\x00-\x7F]" workspace/ --include="*.py"` returns zero results (ENC-02 satisfied)
- The smoke import test produces no UnicodeEncodeError (ENC-01 satisfied)
- Both start scripts export PYTHONUTF8=1 unconditionally at the top level (defense-in-depth)
- ruff reports no new lint errors from the replacements
</success_criteria>

<output>
After completion, create `.planning/phases/01-unicode-source-fix/01-01-SUMMARY.md` using the summary template at `@C:/Users/upayan.ghosh/.claude/get-shit-done/templates/summary.md`.
</output>
